<html lang="en"><head>
    <title>Project Futures Exchange Shanghai Page</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://d3js.org/d3-path.v2.min.js"></script>
    <script src="https://d3js.org/d3-shape.v2.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <script src="https://d3js.org/d3-array.v2.min.js"></script>
    <script src="https://d3js.org/d3-geo.v2.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v3.min.js"></script>
    <script src="https://unpkg.com/react/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone/babel.js"></script>
    <link rel="stylesheet" href="styles.css"> 
    <style>
        body {
          background-color:rgb(53, 50, 50);
        }
    </style>
<script>"use strict";

var _slicedToArray = function () { function sliceIterator(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"]) _i["return"](); } finally { if (_d) throw _e; } } return _arr; } return function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { return sliceIterator(arr, i); } else { throw new TypeError("Invalid attempt to destructure non-iterable instance"); } }; }();

var WIDTH = 1300;
var HEIGHT = 800;
var margin = { top: 20, right: 40, bottom: 20, left: 40 };
var csvUrl = 'https://raw.githubusercontent.com/jjl720/capstone/main/futures_data.csv';

function useData(csvPath) {
var _React$useState = React.useState(null),
    _React$useState2 = _slicedToArray(_React$useState, 2),
    dataAll = _React$useState2[0],
    setData = _React$useState2[1];

React.useEffect(function () {
    d3.csv(csvPath).then(function (data) {
        data.forEach(function (d) {
            d.index = +d.index;
            d.volume = +Math.floor(d.volume / 100000);
            d.tradingvolume = +Math.floor(d.tradingvolume / 1000);
            d.Sharpe = +d.Sharpe;
        });
        setData(data);
    });
}, []);
return dataAll;
}

function TreeMapText(props) {
var d = props.d,
    sty = props.sty;

var result = d.ancestors().reverse().slice(1).map(function (d, idx) {
    return d.data.name;
}).join("\n") + "\nSharpe:" + d3.format("")(d.value);
var result_list = result.split("\n");
if (result_list[0] == 'DCE') {
    var exchange = "Dalian Commodity Exchange";
} else if (result_list[0] == 'CFFEX') {
    var exchange = "China Financial Futures Exchange";
} else if (result_list[0] == 'SHFE') {
    var exchange = "Shanghai Futures Exchange";
} else if (result_list[0] == 'CZCE') {
    var exchange = "Zhengzhou Commodity Exchange";
} else {
    var exchange = "Shanghai Energy Exchange";
}
if (sty == 0) {
    return React.createElement(
        "foreignObject",
        { width: d.x1 - d.x0, height: d.y1 - d.y0 },
        React.createElement(
            "div",
            null,
            React.createElement(
                "p",
                null,
                "Date: ",
                result_list[4].slice(-2) + '\n',
                "Volume: ",
                result_list[1] + '\n',
                "Trading vol: ",
                result_list[3] + '\n',
                "Sharpe: ",
                result_list[2].slice(0, 3) + '\n',
                "Exchange: ",
                exchange
            )
        )
    );
} else {
    return React.createElement(
        "foreignObject",
        { width: (d.x1 - d.x0) * 2, height: (d.y1 - d.y0) * 2 },
        React.createElement(
            "div",
            null,
            React.createElement(
                "h2",
                null,
                "Date: ",
                result_list[4].slice(-2) + '\n',
                "Volume: ",
                result_list[1] + '\n',
                "Trading vol: ",
                result_list[3] + '\n',
                "Sharpe: ",
                result_list[2].slice(0, 3) + '\n',
                "Exchange: ",
                exchange
            )
        )
    );
}
}

function TreeMap(props) {
var width = props.width,
    height = props.height,
    data = props.data,
    first = props.first,
    second = props.second,
    selectedCell = props.selectedCell,
    setSelectedCell = props.setSelectedCell;

var margin = { top: 20, right: 40, bottom: 20, left: 40, gap: 40 };
var innerWidth = width - margin.left - margin.right;
var innerHeight = height - margin.top - margin.bottom;

var attributes = ["Exchange", "volume", "Sharpe", 'tradingvolume', 'ym'];

var root = { name: "root", children: buildTree(data, attributes, first, second), value: 10 };

root = d3.hierarchy(root).sum(function (d) {
    // console.log(d.children ? 0 : d.value);
    return d.children ? 0 : d.value;
});

var tree = d3.treemap().tile(d3.treemapSquarify).size([innerWidth, innerHeight]).padding(2).round(true)(root).sort(function (a, b) {
    return b.value - a.value;
});;

if (second == 0) {
    var parents = tree.leaves().map(function (d) {
        return d.parent.data.group[0]['ym'];
    });
    var attr2 = 'ym';
} else {
    var parents = tree.leaves().map(function (d) {
        return d.parent.data.group[0]['Exchange'];
    });
    var attr2 = 'Exchange';
}

var parentsCategories = parents.filter(function (d, idx) {
    return parents.indexOf(d) === idx;
});

var color = d3.scaleOrdinal(d3.schemePaired).domain(parentsCategories);

var firstLayer = tree.descendants()[0].children;

var mouseOver = function mouseOver(d) {
    setSelectedCell(d);
};

var mouseOut = function mouseOut() {
    setSelectedCell(null);
};
var lefts = tree.leaves().length;
var final = tree.leaves()[lefts - 1];

return React.createElement(
    "g",
    { transform: "translate(" + margin.left + ", " + margin.right + ")" },
    React.createElement(
        "svg",
        { width: width, height: height },
        firstLayer.map(function (d, idx) {

            return React.createElement(
                "g",
                { key: idx + "outerline", transform: "translate(" + d.x0 + ", " + d.y0 + ")" },
                React.createElement("rect", { width: d.x1 - d.x0, height: d.y1 - d.y0, stroke: "white", fill: "none" }),
                React.createElement(
                    "text",
                    { style: { fontSize: "6em", fill: 'White' }, x: (d.x1 - d.x0) / 2, y: (d.y1 - d.y0) / 2, textAnchor: "middle",
                        transform: "rotate(" + (d.x1 - d.x0 > d.y1 - d.y0 ? 0 : 90) + ", " + (d.x1 - d.x0) / 2 + ", " + (d.y1 - d.y0) / 2 + ")" },
                    d.data.name
                )
            );
        }),
        tree.leaves().map(function (d, idx) {
            var info = d;

            if (selectedCell) {
                var gd = selectedCell.value;
                var ind = selectedCell;
            } else {
                var gd = null;
            }
            if (ind) {
                if (ind.data.group[0]['Exchange'] == "SHFE") {
                    var page_info = "Shanghai.html";
                } else if (ind.data.group[0]['Exchange'] == "DCE") {
                    var page_info = "DCE.html";
                } else if (ind.data.group[0]['Exchange'] == "CZCE") {
                    var page_info = "CZCE.html";
                } else if (ind.data.group[0]['Exchange'] == "CFFEX") {
                    var page_info = "CFFEX.html";
                } else {
                    var page_info = "INE.html";
                }
                var date = ind.data.group[0]['ym'] + '=' + ind.data.group[0]['Exchange'];
            }

            if (final.value == d.value) {
                if (!ind) {
                    return React.createElement(
                        "g",
                        { key: idx + "treemap", transform: "translate(" + d.x0 + ", " + d.y0 + ")",
                            onMouseOver: function onMouseOver() {
                                return mouseOver(d);
                            } },
                        React.createElement("rect", { width: d.x1 - d.x0, height: d.y1 - d.y0, stroke: "none",
                            fill: color(d.parent.data.group[0][attr2]),
                            opacity: 0.6 }),
                        React.createElement(TreeMapText, { d: d, sty: 0 })
                    );
                } else {
                    return React.createElement(
                        "g",
                        null,
                        React.createElement(
                            "g",
                            { key: idx + "treemap", transform: "translate(" + d.x0 + ", " + d.y0 + ")",
                                onMouseOver: function onMouseOver() {
                                    return mouseOver(d);
                                } },
                            React.createElement("rect", { width: d.x1 - d.x0, height: d.y1 - d.y0, stroke: "none",
                                fill: color(d.parent.data.group[0][attr2]), opacity: 0.9 }),
                            React.createElement(TreeMapText, { d: d, sty: 0 })
                        ),
                        React.createElement(
                            "a",
                            { href: page_info + '?id=' + date },
                            React.createElement(
                                "g",
                                { transform: "translate(" + ind.x0 + ", " + ind.y0 + ")",
                                    onMouseOver: function onMouseOver() {
                                        return mouseOver(ind);
                                    }, onMouseOut: mouseOut },
                                React.createElement("rect", { width: (ind.x1 - ind.x0) * 2, height: (ind.y1 - ind.y0) * 2, stroke: "none",
                                    fill: color(…</script></head>
<body>
    <div id="root"><div><div><a href="index.html" fill="black"><button class="button"><text fill="black" x="0%" y="0" style="font-size: 2em;">Capstone - Information Vizulization Project </text></button></a><svg width="100%" height="1"><line x2="100%" y1="100%" y2="100%" stroke="White"></line></svg></div><div><div class="select"><select><option value="volume">Volume</option><option value="Sharpe" selected="">Sharpe</option><option value="tradingvolume">Trading Volume</option></select></div><div class="select"><select><option value="4">Date</option><option value="0" selected="">Exchange</option></select></div><input type="range" class="slider" list="tickmarks" min="0" max="3" step="1" value="1"><datalist id="tickmarks"><option value="0"></option><option value="1"></option><option value="2"></option><option value="3"></option></datalist><input class="labelinput" type="text" readonly="" value="Year 2018"></div><div><svg width="150" height="0" fill="black"></svg><g transform="translate(200, 0)"><g transform="translate(40, 40)"><svg width="1300" height="800"><g transform="translate(2, 2)"><rect width="507" height="379" stroke="white" fill="none"></rect><text x="253.5" y="189.5" text-anchor="middle" transform="rotate(0, 253.5, 189.5)" style="font-size: 6em; fill: white;">CFFEX</text></g><g transform="translate(862, 2)"><rect width="356" height="536" stroke="white" fill="none"></rect><text x="178" y="268" text-anchor="middle" transform="rotate(90, 178, 268)" style="font-size: 6em; fill: white;">SHFE</text></g><g transform="translate(2, 383)"><rect width="507" height="375" stroke="white" fill="none"></rect><text x="253.5" y="187.5" text-anchor="middle" transform="rotate(0, 253.5, 187.5)" style="font-size: 6em; fill: white;">CZCE</text></g><g transform="translate(511, 2)"><rect width="349" height="536" stroke="white" fill="none"></rect><text x="174.5" y="268" text-anchor="middle" transform="rotate(90, 174.5, 268)" style="font-size: 6em; fill: white;">DCE</text></g><g transform="translate(511, 540)"><rect width="707" height="218" stroke="white" fill="none"></rect><text x="353.5" y="109" text-anchor="middle" transform="rotate(0, 353.5, 109)" style="font-size: 6em; fill: white;">INE</text></g><g transform="translate(10, 143)"><rect width="199" height="81" stroke="none" fill="#a6cee3" opacity="0.9"></rect><foreignObject width="199" height="81"><div><p>Date: 06
Volume: 19
Trading vol: 22
Sharpe: 3.7
Exchange: China Financial Futures Exchange</p></div></foreignObject></g><g transform="translate(10, 10)"><rect width="114" height="123" stroke="none" fill="#1f78b4" opacity="0.9"></rect><foreignObject width="114" height="123"><div><p>Date: 01
Volume: 19
Trading vol: 19
Sharpe: 3.2
Exchange: China Financial Futures Exchange</p></div></foreignObject></g><g transform="translate(134, 10)"><rect width="75" height="123" stroke="none" fill="#b2df8a" opacity="0.9"></rect><foreignObject width="75" height="123"><div><p>Date: 03
Volume: 19
Trading vol: 19
Sharpe: 2.2
Exchange: China Financial Futures Exchange</p></div></foreignObject></g><g transform="translate(223, 10)"><rect width="73" height="206" stroke="none" fill="#33a02c" opacity="0.9"></rect><foreignObject width="73" height="206"><div><p>Date: 05
Volume: 20
Trading vol: 19
Sharpe: 3.5
Exchange: China Financial Futures Exchange</p></div></foreignObject></g><g transform="translate(306, 10)"><rect width="62" height="206" stroke="none" fill="#fb9a99" opacity="0.9"></rect><foreignObject width="62" height="206"><div><p>Date: 09
Volume: 20
Trading vol: 21
Sharpe: 3.0
Exchange: China Financial Futures Exchange</p></div></foreignObject></g><g transform="translate(382, 10)"><rect width="119" height="101" stroke="none" fill="#e31a1c" opacity="0.9"></rect><foreignObject width="119" height="101"><div><p>Date: 07
Volume: 23
Trading vol: 21
Sharpe: 2.8
Exchange: China Financial Futures Exchange</p></div></foreignObject></g><g transform="translate(382, 121)"><rect width="119" height="95" stroke="none" fill="#fdbf6f" opacity="0.9"></rect><foreignObject width="119" height="95"><div><p>Date: 10
Volume: 23
Trading vol: 18
Sharpe: 2.7
Exchange: China Financial Futures Exchange</p></div></foreignObject></g><g transform="translate(10, 305)"><rect width="199" height="68" stroke="none" fill="#ff7f00" opacity="0.9"></rect><foreignObject width="199" height="68"><div><p>Date: 04
Volume: 18
Trading vol: 19
Sharpe: 3.3
Exchange: China Financial Futures Exchange</p></div></foreignObject></g><g transform="translate(410, 230)"><rect width="91" height="143" stroke="none" fill="#cab2d6" opacity="0.9"></rect><foreignObject width="91" height="143"><div><p>Date: 12
Volume: 32
Trading vol: 23
Sharpe: 3.1
Exchange: China Financial Futures Exchange</p></div></foreignObject></g><g transform="translate(223, 230)"><rect width="173" height="66" stroke="none" fill="#6a3d9a" opacity="0.9"></rect><foreignObject width="173" height="66"><div><p>Date: 08
Volume: 28
Trading vol: 32
Sharpe: 2.8
Exchange: China Financial Futures Exchange</p></div></foreignObject></g><g transform="translate(223, 310)"><rect width="173" height="63" stroke="none" fill="#ffff99" opacity="0.9"></rect><foreignObject width="173" height="63"><div><p>Date: 11
Volume: 29
Trading vol: 38
Sharpe: 2.7
Exchange: China Financial Futures Exchange</p></div></foreignObject></g><g transform="translate(10, 238)"><rect width="199" height="53" stroke="none" fill="#b15928" opacity="0.9"></rect><foreignObject width="199" height="53"><div><p>Date: 02
Volume: 15
Trading vol: 14
Sharpe: 2.7
Exchange: China Financial Futures Exchange</p></div></foreignObject></g><g transform="translate(1126, 10)"><rect width="84" height="167" stroke="none" fill="#ff7f00" opacity="0.9"></rect><foreignObject width="84" height="167"><div><p>Date: 04
Volume: 1002
Trading vol: 1245
Sharpe: 3.3
Exchange: Shanghai Futures Exchange</p></div></foreignObject></g><g transform="translate(870, 365)"><rect width="168" height="80" stroke="none" fill="#e31a1c" opacity="0.9"></rect><foreignObject width="168" height="80"><div><p>Date: 07
Volume: 1023
Trading vol: 691
Sharpe: 3.2
Exchange: Shanghai Futures Exchange</p></div></foreignObject></g><g transform="translate(870, 191)"><rect width="168" height="77" stroke="none" fill="#33a02c" opacity="0.9"></rect><foreignObject width="168" height="77"><div><p>Date: 05
Volume: 920
Trading vol: 1172
Sharpe: 3.1
Exchange: Shanghai Futures Exchange</p></div></foreignObject></g><g transform="translate(958, 10)"><rect width="76" height="167" stroke="none" fill="#b15928" opacity="0.9"></rect><foreignObject width="76" height="167"><div><p>Date: 02
Volume: 512
Trading vol: 422
Sharpe: 3.1
Exchange: Shanghai Futures Exchange</p></div></foreignObject></g><g transform="translate(1134, 362)"><rect width="76" height="168" stroke="none" fill="#cab2d6" opacity="0.9"></rect><foreignObject width="76" height="168"><div><p>Date: 12
Volume: 1136
Trading vol: 1331
Sharpe: 3.1
Exchange: Shanghai Futures Exchange</p></div></foreignObject></g><g transform="translate(870, 10)"><rect width="74" height="167" stroke="none" fill="#1f78b4" opacity="0.9"></rect><foreignObject width="74" height="167"><div><p>Date: 01
Volume: 861
Trading vol: 966
Sharpe: 3.0
Exchange: Shanghai Futures Exchange</p></div></foreignObject></g><g transform="translate(870, 459)"><rect width="168" height="71" stroke="none" fill="#6a3d9a" opacity="0.9"></rect><foreignObject width="168" height="71"><div><p>Date: 08
Volume: 1199
Trading vol: 975
Sharpe: 2.9
Exchange: Shanghai Futures Exchange</p></div></foreignObject></g><g transform="translate(870, 282)"><rect width="168" height="69" stroke="none" fill="#a6cee3" opacity="0.9"></rect><foreignObject width="168" height="69"><div><p>Date: 06
Volume: 893
Trading vol: 978
Sharpe: 2.8
Exchange: Shanghai Futures Exchange</p></div></foreignObject></g><g transform="translate(1052, 362)"><rect width="68" height="168" stroke="none" fill="#ffff99" opacity="0.9"></rect><foreignObject width="68" height="168"><div><p>Date: 11
Volume: 1232
Trading vol: 1502
Sharpe: 2.8
Exchange: Shanghai Futures Exchange</p></div></foreignObject></g><g transform="translate(1052, 191)"><rect width="74" height="157" stroke="none" fill="#fb9a99" opacity="0.9"></rect><foreignObject width="74" height="157"><div><p>Date: 09
Volume: 963
Trading vol: 983
Sharpe: 2.8
Exchange: Shanghai Futures Exchange</p></div></foreignObject></g><g transform="translate(1140, 191)"><rect width="70" height="157" stroke="none" fill="#fdbf6f" opacity="0.9"></rect><foreignObject width="70" height="157"><div><p>Date: 10
Volume: 883
Trading vol: 978
Sharpe: 2.7
Exchange: Shanghai Futures Exchange</p></div></foreignObject></g><g transform="translate(1048, 10)"><rect width="64" height="167" stroke="none" fill="#b2df8a" opacity="0.9"></rect><foreignObject width="64" height="167"><div><p>Date: 03
Volume: 1112
Trading vol: 789
Sharpe: 2.6
Exchange: Shanghai Futures Exchange</p></div></foreignObject></g><g transform="translate(286, 391)"><rect width="107" height="137" stroke="none" fill="#a6cee3" opacity="0.9"></rect><foreignObject width="107" height="137"><div><p>Date: 06
Volume: 782
Trading vol: 1031
Sharpe: 3.4
Exchange: Zhengzhou Commodity Exchange</p></div></foreignObject></g><g transform="translate(10, 391)"><rect width="155" height="87" stroke="none" fill="#1f78b4" opacity="0.9"></rect><foreignObject width="155" height="87"><div><p>Date: 01
Volume: 434
Trading vol: 526
Sharpe: 3.2
Exchange: Zhengzhou Commodity Exchange</p></div></foreignObject></g><g transform="translate(407, 391)"><rect width="94" height="137" stroke="none" fill="#e31a1c" opacity="0.9"></rect><foreignObject width="94" height="137"><div><p>Date: 07
Volume: 658
Trading vol: 652
Sharpe: 3.1
Exchange: Zhengzhou Commodity Exchange</p></div></foreignObject></g><g transform="translate(10, 580)"><rect width="155" height="82" stroke="none" fill="#b2df8a" opacity="0.9"></rect><foreignObject width="155" height="82"><div><p>Date: 03
Volume: 594
Trading vol: 366
Sharpe: 3.0
Exchange: Zhengzhou Commodity Exchange</p></div></foreignObject></g><g transform="translate(179, 391)"><rect width="93" height="137" stroke="none" fill="#33a02c" opacity="0.9"></rect><foreignObject width="93" height="137"><div><p>Date: 05
Volume: 958
Trading vol: 723
Sharpe: 3.0
Exchange: Zhengzhou Commodity Exchange</p></div></foreignObject></g><g transform="translate(412, 542)"><rect width="89" height="138" stroke="none" fill="#ffff99" opacity="0.9"></rect><foreignObject width="89" height="138"><div><p>Date: 11
Volume: 764
Trading vol: 687
Sharpe: 2.9
Exchange: Zhengzhou Commodity Exchange</p></div></foreignObject></g><g transform="translate(312, 542)"><rect width="86" height="138" stroke="none" fill="#fdbf6f" opacity="0.9"></rect><foreignObject width="86" height="138"><div><p>Date: 10
Volume: 591
Trading vol: 697
Sharpe: 2.9
Exchange: Zhengzhou Commodity Exchange</p></div></foreignObject></g><g transform="translate(179, 649)"><rect width="119" height="101" stroke="none" fill="#fb9a99" opacity="0.9"></rect><foreignObject width="119" height="101"><div><p>Date: 09
Volume: 644
Trading vol: 728
Sharpe: 2.8
Exchange: Zhengzhou Commodity Exchange</p></div></foreignObject></g><g transform="translate(10, 492)"><rect width="155" height="74" stroke="none" fill="#b15928" opacity="0.9"></rect><foreignObject width="155" height="74"><div><p>Date: 02
Volume: 277
Trading vol: 205
Sharpe: 2.8
Exchange: Zhengzhou Commodity Exchange</p></div></foreignObject></g><g transform="translate(10, 676)"><rect width="155" height="74" stroke="none" fill="#ff7f00" opacity="0.9"></rect><foreignObject width="155" height="74"><div><p>Date: 04
Volume: 458
Trading vol: 549
Sharpe: 2.8
Exchange: Zhengzhou Commodity Exchange</p></div></foreignObject></g><g transform="translate(312, 694)"><rect width="189" height="56" stroke="none" fill="#cab2d6" opacity="0.9"></rect><foreignObject width="189" height="56"><div><p>Date: 12
Volume: 787
Trading vol: 994
Sharpe: 2.7
Exchange: Zhengzhou Commodity Exchange</p></div></foreignObject></g><g transform="translate(179, 542)"><rect width="119" height="93" stroke="none" fill="#6a3d9a" opacity="0.9"></rect><foreignObject width="119" height="93"><div><p>Date: 08
Volume: 1181
Trading vol: 1291
Sharpe: 2.7
Exchange: Zhengzhou Commodity Exchange</p></div></foreignObject></g><g transform="translate(519, 10)"><rect width="109" height="128" stroke="none" fill="#1f78b4" opacity="0.9"></rect><foreignObject width="109" height="128"><div><p>Date: 01
Volume: 720
Trading vol: 516
Sharpe: 3.2
Exchange: Dalian Commodity Exchange</p></div></foreignObject></g><g transform="translate(652, 325)"><rect width="101" height="136" stroke="none" fill="#fdbf6f" opacity="0.9"></rect><foreignObject width="101" height="136"><div><p>Date: 10
Volume: 696
Trading vol: 819
Sharpe: 3.2
Exchange: Dalian Commodity Exchange</p></div></foreignObject></g><g transform="translate(687, 152)"><rect width="79" height="159" stroke="none" fill="#a6cee3" opacity="0.9"></rect><foreignObject width="79" height="159"><div><p>Date: 06
Volume: 809
Trading vol: 670
Sharpe: 3.0
Exchange: Dalian Commodity Exchange</p></div></foreignObject></g><g transform="translate(752, 10)"><rect width="100" height="128" stroke="none" fill="#b2df8a" opacity="0.9"></rect><foreignObject width="100" height="128"><div><p>Date: 03
Volume: 1094
Trading vol: 763
Sharpe: 3.0
Exchange: Dalian Commodity Exchange</p></div></foreignObject></g><g transform="translate(642, 10)"><rect width="96" height="128" stroke="none" fill="#b15928" opacity="0.9"></rect><foreignObject width="96" height="128"><div><p>Date: 02
Volume: 438
Trading vol: 481
Sharpe: 2.9
Exchange: Dalian Commodity Exchange</p></div></foreignObject></g><g transform="translate(598, 152)"><rect width="75" height="159" stroke="none" fill="#33a02c" opacity="0.9"></rect><foreignObject width="75" height="159"><div><p>Date: 05
Volume: 939
Trading vol: 943
Sharpe: 2.9
Exchange: Dalian Commodity Exchange</p></div></foreignObject></g><g transform="translate(519, 325)"><rect width="119" height="100" stroke="none" fill="#6a3d9a" opacity="0.9"></rect><foreignObject width="119" height="100"><div><p>Date: 08
Volume: 914
Trading vol: 1175
Sharpe: 2.8
Exchange: Dalian Commodity Exchange</p></div></foreignObject></g><g transform="translate(652, 475)"><rect width="200" height="55" stroke="none" fill="#cab2d6" opacity="0.9"></rect><foreignObject width="200" height="55"><div><p>Date: 12
Volume: 761
Trading vol: 828
Sharpe: 2.8
Exchange: Dalian Commodity Exchange</p></div></foreignObject></g><g transform="translate(780, 152)"><rect width="72" height="159" stroke="none" fill="#e31a1c" opacity="0.9"></rect><foreignObject width="72" height="159"><div><p>Date: 07
Volume: 741
Trading vol: 740
Sharpe: 2.8
Exchange: Dalian Commodity Exchange</p></div></foreignObject></g><g transform="translate(767, 325)"><rect width="85" height="136" stroke="none" fill="#ffff99" opacity="0.9"></rect><foreignObject width="85" height="136"><div><p>Date: 11
Volume: 903
Trading vol: 925
Sharpe: 2.7
Exchange: Dalian Commodity Exchange</p></div></foreignObject></g><g transform="translate(519, 439)"><rect width="119" height="91" stroke="none" fill="#fb9a99" opacity="0.9"></rect><foreignObject width="119" height="91"><div><p>Date: 09
Volume: 668
Trading vol: 796
Sharpe: 2.6
Exchange: Dalian Commodity Exchange</p></div></foreignObject></g><g transform="translate(519, 152)"><rect width="65" height="159" stroke="none" fill="#ff7f00" opacity="0.9"></rect><foreignObject width="65" height="159"><div><p>Date: 04
Volume: 1004
Trading vol: 957
Sharpe: 2.6
Exchange: Dalian Commodity Exchange</p></div></foreignObject></g><g transform="translate(767, 548)"><rect width="114" height="111" stroke="none" fill="#e31a1c" opacity="0.9"></rect><foreignObject width="114" height="111"><div><p>Date: 07
Volume: 27
Trading vol: 20
Sharpe: 2.9
Exchange: Shanghai Energy Exchange</p></div></foreignObject></g><g transform="translate(891, 548)"><rect width="76" height="111" stroke="none" fill="#fb9a99" opacity="0.9"></rect><foreignObject width="76" height="111"><div><p>Date: 09
Volume: 27
Trading vol: 37
Sharpe: 2.0
Exchange: Shanghai Energy Exchange</p></div></foreignObject></g><g transform="translate(981, 619)"><rect width="148" height="131" stroke="none" fill="#ffff99" opacity="0.9"></rect><foreignObject width="148" height="131"><div><p>Date: 11
Volume: 45
Trading vol: 69
Sharpe: 4.4
Exchange: Shanghai Energy Exchange</p></div></foreignObject></g><g transform="translate(767, 673)"><rect width="200" height="77" stroke="none" fill="#6a3d9a" opacity="0.9"></rect><foreignObject width="200" height="77"><div><p>Date: 08
Volume: 33
Trading vol: 30
Sharpe: 3.7
Exchange: Shanghai Energy Exchange</p></div></foreignObject></g><g transform="translate(606, 548)"><rect width="147" height="106" stroke="none" fill="#33a02c" opacity="0.9"></rect><foreignObject width="147" height="106"><div><p>Date: 05
Volume: 18
Trading vol: 18
Sharpe: 3.6
Exchange: Shanghai Energy Exchange</p></div></foreignObject></g><g transform="translate(1143, 548)"><rect width="67" height="202" stroke="none" fill="#cab2d6" opacity="0.9"></rect><foreignObject width="67" height="202"><div><p>Date: 12
Volume: 50
Trading vol: 66
Sharpe: 3.3
Exchange: Shanghai Energy Exchange</p></div></foreignObject></g><g transform="translate(606, 668)"><rect width="147" height="82" stroke="none" fill="#a6cee3" opacity="0.9"></rect><foreignObject width="147" height="82"><div><p>Date: 06
Volume: 22
Trading vol: 2
Sharpe: 2.9
Exchange: Shanghai Energy Exchange</p></div></foreignObject></g><g transform="translate(519, 548)"><rect width="73" height="137" stroke="none" fill="#b2df8a" opacity="0.9"></rect><foreignObject width="73" height="137"><div><p>Date: 03
Volume: 1
Trading vol: 2
Sharpe: 2.4
Exchange: Shanghai Energy Exchange</p></div></foreignObject></g><g transform="translate(981, 548)"><rect width="148" height="57" stroke="none" fill="#fdbf6f" opacity="0.9"></rect><foreignObject width="148" height="57"><div><p>Date: 10
Volume: 30
Trading vol: 14
Sharpe: 2.1
Exchange: Shanghai Energy Exchange</p></div></foreignObject></g><g transform="translate(519, 699)"><rect width="73" height="51" stroke="none" fill="#ff7f00" opacity="0.6"></rect><foreignObject width="73" height="51"><div><p>Date: 04
Volume: 6
Trading vol: 6
Sharpe: 1.0
Exchange: Shanghai Energy Exchange</p></div></foreignObject></g></svg></g></g></div></div></div>
    <script type="text/babel">

        const WIDTH = 1300;
        const HEIGHT = 800;
        const margin = { top: 20, right: 40, bottom: 20, left: 40 };
        const csvUrl = 'https://raw.githubusercontent.com/jjl720/capstone/main/futures_data.csv';

        function useData(csvPath){
            const [dataAll, setData] = React.useState(null);
            React.useEffect(() => {
                d3.csv(csvPath).then(data => {
                    data.forEach(d => {
                        d.index =+ d.index;
                        d.volume =+ Math.floor(d.volume/100000);
                        d.tradingvolume= + Math.floor(d.tradingvolume/1000);
                        d.Sharpe= +d.Sharpe;
                
                    });
                    setData(data);
                });
            }, []);
            return dataAll;
        }


        function TreeMapText(props) {
            const {d, sty} = props;
            const result = d.ancestors().reverse().slice(1).map((d, idx) => d.data.name)
                        .join("\n")+"\nSharpe:"+d3.format("")(d.value)
            const result_list = result.split("\n"); 
            if (result_list[0]=='DCE') {
                var exchange = "Dalian Commodity Exchange";
            } else if (result_list[0]=='CFFEX') {
                var exchange = "China Financial Futures Exchange";
            } else if (result_list[0]=='SHFE') {
                var exchange = "Shanghai Futures Exchange";
            } else if (result_list[0]=='CZCE') {
                var exchange = "Zhengzhou Commodity Exchange";
            } else {
                var exchange = "Shanghai Energy Exchange";
            }
            if (sty == 0) {
                return <foreignObject width={d.x1-d.x0} height={d.y1-d.y0}>
                <div >
                    <p>
                        Date: {result_list[4].slice(-2)+'\n'}
                        Volume: {result_list[1]+'\n'}
                        Trading vol: {result_list[3]+'\n'}
                        Sharpe: {result_list[2].slice(0,3)+'\n'}
                        Exchange: {exchange}
                    </p>
                </div>
                </foreignObject>
            } else {
            return <foreignObject width={(d.x1-d.x0)*2} height={(d.y1-d.y0)*2}>
                <div >
                    
                    <h2>
                        Date: {result_list[4].slice(-2)+'\n'}
                        Volume: {result_list[1]+'\n'}
                        Trading vol: {result_list[3]+'\n'}
                        Sharpe: {result_list[2].slice(0,3)+'\n'}
                        Exchange: {exchange}
                    </h2>
                    
                </div>
                </foreignObject>
            }
        }

  

    function TreeMap(props) {
        const { width, height, data, first, second, selectedCell, setSelectedCell} = props;
        const margin = { top: 20, right: 40, bottom: 20, left: 40, gap: 40 };
        const innerWidth = width - margin.left - margin.right;
        const innerHeight = height - margin.top - margin.bottom;
        
        let attributes = ["Exchange","volume", "Sharpe",'tradingvolume','ym'];
     
        var root = {name: "root", children: buildTree(data, attributes, first, second), value: 10};  
     

        root = d3.hierarchy(root)
            .sum(d => {
                // console.log(d.children ? 0 : d.value);
                return d.children ? 0 : d.value;
            });
        
        const tree = d3.treemap().tile(d3.treemapSquarify).size([innerWidth, innerHeight]).padding(2)
            .round(true)(root).sort((a, b) => b.value - a.value);;

  
        if (second == 0) {
            var parents = tree.leaves().map( d => d.parent.data.group[0]['ym']);
            var attr2 = 'ym';
        } else {
            var parents = tree.leaves().map( d => d.parent.data.group[0]['Exchange']);
            var attr2 = 'Exchange';
        }

        let parentsCategories = parents.filter( (d, idx) => parents.indexOf(d) === idx );
        
        const color = d3.scaleOrdinal(d3.schemePaired).domain(parentsCategories);
        
        const firstLayer = tree.descendants()[0].children;

        const mouseOver = d => {
            setSelectedCell(d);
        };

        const mouseOut = () => {
            setSelectedCell(null);
        };
        const lefts = tree.leaves().length
        const final = tree.leaves()[lefts-1]
       
        
        return <g transform={`translate(${margin.left}, ${margin.right})`}>
            <svg width ={width} height = {height}>

            {firstLayer.map( (d, idx) => {
                
                return <g key={idx+"outerline"} transform={`translate(${d.x0}, ${d.y0})`}>
                    <rect width={d.x1-d.x0} height={d.y1-d.y0} stroke={"white"} fill={"none"}/>
                    <text style={{fontSize:"6em", fill:'White'}} x={ (d.x1-d.x0)/2 } y={ (d.y1-d.y0)/2} textAnchor={"middle"}  
                    transform={`rotate(${(d.x1-d.x0)>(d.y1-d.y0)? 0: 90}, ${(d.x1-d.x0)/2}, ${(d.y1-d.y0)/2})`}>
                        {d.data.name}
                    </text>
                    </g>
            })}


            
            {tree.leaves().map( (d, idx) => {
                const info = d;
         
                if (selectedCell) {
                    var gd = selectedCell.value;
                    var ind = selectedCell;
                   
                } else {
                    var gd = null;
                }
                if (ind) {
                    if (ind.data.group[0]['Exchange'] == "SHFE") {
                        var page_info = "Shanghai.html";
                    } else if (ind.data.group[0]['Exchange'] =="DCE") {
                        var page_info = "DCE.html";
                    } else if (ind.data.group[0]['Exchange'] == "CZCE") {
                        var page_info = "CZCE.html";
                    } else if (ind.data.group[0]['Exchange'] == "CFFEX") {
                        var page_info = "CFFEX.html";
                    } else {
                        var page_info = "INE.html";
                    }
                    var date = ind.data.group[0]['ym']+ '='+ind.data.group[0]['Exchange'];
                }
                
                if (final.value == d.value) {
                    if (!ind) {
                        return <g key={idx+"treemap"} transform={`translate(${d.x0}, ${d.y0})`}
                        onMouseOver= {()=> mouseOver(d)}>
                                    <rect width={d.x1-d.x0} height={d.y1-d.y0} stroke={"none"}
                                    fill={color(d.parent.data.group[0][attr2])} 
                                    opacity={0.6}/>
                                    <TreeMapText d={d} sty ={0}/> 
                                </g>
                    } else {
                        return <g>
                        <g key={idx+"treemap"} transform={`translate(${d.x0}, ${d.y0})`} 
                        onMouseOver= {()=> mouseOver(d)}>
                            <rect width={d.x1-d.x0} height={d.y1-d.y0} stroke={"none"}
                            fill={color(d.parent.data.group[0][attr2])} opacity={0.9}/>
                            <TreeMapText d={d} sty ={0}/> 
                        </g>

                        <a href={page_info+'?id='+date} >
                        <g transform={`translate(${ind.x0}, ${ind.y0})`}
                        onMouseOver= {()=> mouseOver(ind)} onMouseOut = {mouseOut}>
                            <rect width={(ind.x1-ind.x0)*2} height={(ind.y1-ind.y0)*2} stroke={"none"}
                            fill={color(ind.parent.data.group[0][attr2])} 
                            />
                            <TreeMapText d={ind} sty ={1}/> 
                        </g>
                        </a>
                        
                        </g>
                        
                    }
                    
                } else {
                    return <g key={idx+"treemap"} transform={`translate(${d.x0}, ${d.y0})`}
                        onMouseOver= {()=> mouseOver(d)}>
                    <rect width={d.x1-d.x0} height={d.y1-d.y0} stroke={"none"}
                        fill={color(d.parent.data.group[0][attr2])} opacity={0.9}/>
                    <TreeMapText d={d} sty ={0}/> 
                    </g>
                
                } 
                
            })}
            
            </svg>
            </g>
        
    }
    
    function buildTree(data, attributes,first, second) {
        let itemArr = [];
        if (attributes.length === 0){
            return null;
        }
        let groups = d3.groups( data, d => d[attributes[second]]);
        let levels = groups.map( d => d[0]);

        for (let i = 0; i < levels.length; i++) {
            let volume_size = groups[i][1].filter( d => d.volume)/groups[i][1].length;
            itemArr.push({name: levels[i], children: buildTree(groups[i][1], attributes.slice(1), first,0),
                value: groups[i][1][0][first], group: groups[i][1]});
        } 
        return itemArr;
    }

    function Dropdown (props) {
        const { options, selectedValue, onSelectedValueChange } = props;
        
        return <div class = 'select'><select defaultValue={selectedValue} onChange={event => { onSelectedValueChange(event.target.value)}}>
            {options.map( ({value, label}) => {
                return <option key={label} value={value} >
                    {label}
                </option>
            })}
        </select>
        </div>
     
    }

    const Home_page = () => {
        const [firstAttr, setFirstAttr] = React.useState("Sharpe"); 
        const [secondAttr, setSecondAttr] = React.useState(0); 
        const [year, setYear] = React.useState('1');
        const [selectedCell, setSelectedCell] = React.useState(null);
        const selected= 'Sharpe';
        const dataAll = useData(csvUrl);
        const YEAR = ['2017','2018','2019','2020'];
        if (!dataAll) {
            return <p>
                Loading...
            </p>
        }

        const data = dataAll.filter( d => {
            return d.ym.slice(0, 4) == YEAR[year];
        });
        const onFristAttrChange = ( attr ) => {
            setFirstAttr(attr);
        }
        const onSecondAttrChange = ( attr ) => {
            setSecondAttr(attr);
        }
        const changeHandlerYear = (event) => {
            setYear(event.target.value);
        }
        
        
        const options = [{value: "volume", label: "Volume"},{value: "Sharpe", label: "Sharpe"}, {value: "tradingvolume", label:"Trading Volume"},];
        const options2 = [{value: 4, label: "Date"},{value:0, label: "Exchange"}];
        
        return <div>
            <div>
                <a href = 'index.html' fill = 'black'>
                <button class = 'button'>
                    <text style={{ textAnchor:'bottom', fontSize:'2em'}} fill = 'black' x = {"0%"} y = {"0"}>
                        Capston - Information Vizulization Project
                    </text>
                </button>
                </a>
                <svg width = '100%' height = '1'>
                <line  x2="100%" y1="100%" y2="100%" stroke = "White"/>
                </svg>
            </div>


            <div>
                <Dropdown options={options} selectedValue={firstAttr} onSelectedValueChange={onFristAttrChange}/>
                <Dropdown options={options2} selectedValue={secondAttr} onSelectedValueChange={onSecondAttrChange}/>   
                <input key="slider" type='range' class = 'slider' list="tickmarks" min='0' max='3' value={year}  step='1' onChange={changeHandlerYear}/>
                    <datalist id="tickmarks">
                        <option value="0"></option>
                        <option value="1"></option>
                        <option value="2"></option>
                        <option value="3"></option>
                    </datalist>
                <input key="monthText" class='labelinput' type="text" value={'Year '+YEAR[year]} readOnly/>
            </div>

            <div> 
            <svg width ={150} height = {20} fill ={"black"}>
            </svg>
            <g transform={`translate(${200}, ${0})`}>
            <TreeMap width={WIDTH} height={HEIGHT} data = {data} first = {firstAttr} second = {secondAttr} selectedCell={selectedCell} setSelectedCell={setSelectedCell} />       
            </g>
            </div>
        </div>
        }

        ReactDOM.render( <Home_page/>, document.getElementById('root'));
    </script>

</body></html>
